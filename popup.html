<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 10px;
      margin: 0;
    }
    button {
      background: #0079bf;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 6px;
    }
    button:hover {
      opacity: 0.9;
    }
    /* Custom button colors */
    .low { background: #61bd4f; }
    .medium { background: #f2d600; color: black; }
    .high { background: #eb5a46; }
    /* Highlight for selected score */
    .selected {
      border: 2px solid black;
    }
  </style>
</head>
<body>
  <button class="low" data-score="Low">Low</button>
  <button class="medium" data-score="Medium">Medium</button>
  <button class="high" data-score="High">High</button>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
<script>
  var t = window.TrelloPowerUp.iframe();
  var SCORE_KEY = 'card-score';

  // Load current score and highlight selected button
  t.get('card', 'shared', SCORE_KEY).then(function(score) {
    if (score) {
      const button = document.querySelector(`button[data-score="${score}"]`);
      if (button) button.classList.add('selected');
    }
  });

  // Add click event to all buttons
  document.querySelectorAll('button').forEach(function(button) {
    button.addEventListener('click', function() {
      var score = button.getAttribute('data-score');
      
      // Save to Trello card
      t.set('card', 'shared', SCORE_KEY, score)
        .then(function() {
          // Highlight selected button
          document.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          button.classList.add('selected');
          
          // **********************************************
          // ðŸš€ THE CRUCIAL FIX: Signal Trello to refresh the view
          // This tells Trello that data has changed, so it should re-request
          // and re-render the card-badges and card-back-section.
          t.notifyParent('done', { score: score }); 
          // **********************************************

          return t.closePopup();
        });
    });
  });
</script>
</body>
</html>